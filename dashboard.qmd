---
title: "Wingspan Data"
author: "Noah Bolohan"
format:
  dashboard:
    nav-buttons:
      - icon: github
        href: https://github.com/NoahBolohan/wingspan-dashboard
    css:
      styles.css
---

```{r "imports"}
library(tidyverse)
library(gt)
library(plotly)
library(slider)

invisible(
    lapply(
        list.files(
            "./R",
            full.names = TRUE
        ),
        source
    )
)
```

```{r "Download Google Sheet"}
wingspan_scores <- get_google_sheet(
  sheetId = 2096833443
)

wingspan_scores <- wingspan_scores |>
    mutate(
        game = 1:nrow(
            wingspan_scores
        ),
        .before = 1
    )
```

```{r "Stacked player score"}
stacked_player_scores <- lapply(
        1:7,
        iterative_pivot,
        df = wingspan_scores
    ) |> 
    bind_rows() |>
    drop_na() |>
    group_by(game) |>
    mutate(
        winner = case_when(
        score >= max(score, na.rm = TRUE) ~ TRUE,
        .default = FALSE
        )
    ) |>
    ungroup()
```

# Home

Some summary data for all recorded games of Wingspan in [my score sheet](https://docs.google.com/spreadsheets/d/1K600qeRyYevSrMBUyevP4sZ4vRIBzq4ggCl3cLjHAvc/edit?usp=sharing). Only players with >= 10 games recorded are included in these summaries.


[Data](#data)

[Leaderboards](#leaderboard)\

Tips:

- Drag on plots to zoom in
- Double-tap plots to reset
- Dashboard data refreshes daily at 7am Eastern or when I make a change

```{r "Text: last update (data)"}
#| content: valuebox
#| title: "Last updated"
list(
  icon = "clock-history",
  value = format(
    now(tzone="America/New_York"),
    "%b. %d, '%y, %H:%M"
  )
)
```

# Data

```{r "Table: Summary"}

stacked_player_scores |>
    filter(
        score_type == "total_score"
    ) |>
    group_by(
        Name
    ) |>
    mutate(
        group_size = n()
    ) |> 
    filter(
        group_size >= 10
    ) |>
    arrange(
        game
    ) |>
    mutate(
        "N" = n(),
        "Won" = sum(winner),
        "%" = round(
            100 * sum(
                winner
            ) / n(),
            1
        ),
        "Max" = max(score),
        "Min" = min(score),
        "Mean" = round(
            mean(score),
            1
        )
    ) |>
    select(
        c(
            Name,
            "N",
            "Won",
            "%",
            "Max",
            "Min",
            "Mean"
        )
    ) |>
    filter(
        row_number() == 1
    ) |>
    mutate(
        Name = str_trunc(
            Name,
            width=7
        )
    ) |>
    arrange(
        Name
    ) |>
    gt(
        groupname_col = NULL,
        rowname_col = "Name"
    ) |>
    tab_header(
        title = "Summary statistics",
        subtitle = "Min. 10 games played"
    )

```

```{r "Plot: Total score per game"}

player_scores_total <- stacked_player_scores |>
    filter(
        score_type == "total_score"
    ) |>
    group_by(
        Name
    ) |>
    mutate(
        group_size = n()
    ) |> 
    filter(
        group_size >= 10
    ) |>
    arrange(
        game
    ) |>
    mutate(
        game_number = row_number()
    ) %>%
    split(
        .,
        .$Name
    )

p <- player_scores_total[[1]] %>%
    plot_ly( 
        x = ~game_number,
        y = ~score,
        type = "scatter",
        mode = "lines",
        visible = TRUE
    )   

for (name in names(player_scores_total)[-1]) {
    if (name != "Alex") {
        p <- p %>% add_lines(
            data = player_scores_total[[name]],
            x = ~game_number,
            y = ~score,
            visible = FALSE,
            name = name
        )
    }
}
  
pp <- p %>%
  layout(
    title = list(
      text = "Total score per game",
      x = 0,
      xanchor = "left"
    ),
    xaxis = list(title = "Game number"),
    yaxis = list(title = "Score"),
    showlegend = FALSE,
    margin = list(
        l=40,
        r=0
    ),
    updatemenus = list(
        list(
            y = 1.15,
            yanchor="top",
            x = 0.99,
            xanchor = "right",
            buttons = lapply(
                names(player_scores_total),
                function(name) {
                    list(
                        method="update", 
                        args = list(
                            list(
                                visible = as.logical(
                                    match(
                                        names(
                                            player_scores_total
                                        ),
                                        name,
                                        nomatch=FALSE
                                    )
                                )
                            )
                        ),
                        label = name
                    )
                }
            )
        )
    )
  ) |>
  config(
    modeBarButtonsToRemove = list(
        "zoom2d",
        "pan2d",
        "toImage",
        "zoomIn2d",
        "zoomOut2d",
        "autoScale2d",
        "hoverCompareCartesian",
        "hoverClosestCartesian"
    ),
    displayModeBar = FALSE
  )

pp
```

```{r "Plot: Rolling win rate"}

player_scores_total <- stacked_player_scores |>
    filter(
        score_type == "total_score"
    ) |>
    group_by(
        Name
    ) |>
    mutate(
        group_size = n()
    ) |> 
    filter(
        group_size >= 10
    ) |>
    arrange(
        game
    ) |>
    mutate(
        game_number = row_number(),
        rolling_wr = 100 * slide_dbl(
            winner,
            mean,
            .before = 50,
            .after = 0
        )
    ) %>%
    split(
        .,
        .$Name
    )

p <- player_scores_total[[1]] %>%
    plot_ly( 
        x = ~game_number,
        y = ~rolling_wr,
        type = "scatter",
        mode = "lines",
        visible = TRUE
    )   

for (name in names(player_scores_total)[-1]) {
    if (name != "Alex") {
        p <- p %>% add_lines(
            data = player_scores_total[[name]],
            x = ~game_number,
            y = ~rolling_wr,
            visible = FALSE,
            name = name
        )
    }
}
  
pp <- p %>%
  layout(
    title = list(
      text = "Rolling % (50 games)",
      x = 0,
      xanchor = "left"
    ),
    xaxis = list(title = "Game number"),
    yaxis = list(title = "Win rate (%)"),
    showlegend = FALSE,
    margin = list(
        l=40,
        r=0
    ),
    updatemenus = list(
        list(
            y = 1.15,
            yanchor="top",
            x = 0.99,
            xanchor = "right",
            buttons = lapply(
                names(player_scores_total),
                function(name) {
                    list(
                        method="update", 
                        args = list(
                            list(
                                visible = as.logical(
                                    match(
                                        names(
                                            player_scores_total
                                        ),
                                        name,
                                        nomatch=FALSE
                                    )
                                )
                            )
                        ),
                        label = name
                    )
                }
            )
        )
    )
  ) |>
  config(
    modeBarButtonsToRemove = list(
        "zoom2d",
        "pan2d",
        "toImage",
        "zoomIn2d",
        "zoomOut2d",
        "autoScale2d",
        "hoverCompareCartesian",
        "hoverClosestCartesian"
    ),
    displayModeBar = FALSE
  )

pp
```

# Leaderboard

```{r "Compute leaderboard records"}

leader_board_table <- data.frame(
    Record=character(),
    Holder=character(),
    Value=integer(),
    Date=character()
)

# Highest score per type
highest_scores_per_type <- stacked_player_scores |>
    group_by(
        score_type
    ) |>
    arrange(
        game
    ) |>
    select(
        c(
            game,
            timestamp,
            Name,
            score,
            score_type
        )
    ) %>%
    mutate(
        cumulative_max = cummax(
            score
        ),
        is_new_max = cumulative_max != lag(
            cumulative_max,
            default = first(
                cumulative_max
            )
        ),
        corresponding_Name = ifelse(
            is_new_max|row_number()==1,
            Name,
            NA
        ),
        corresponding_timestamp = ifelse(
            is_new_max|row_number()==1,
            timestamp,
            NA
        ),
        score_type = recode(
            score_type,
            birds = "Most Bird Points",
            bonus_cards = "Most Bonus Card Points",
            duet_tokens = "Most Duet Tokens",
            eggs = "Most Eggs Laid",
            "end-of-round_goals" = "Most End-of-round Points",
            food_on_cards = "Most Cached Food",
            nectar = "Most Nectar Points",
            total_score = "Highest Score",
            tucked_cards = "Most Tucked Cards"
        )
    ) %>%
    fill(
        corresponding_Name,
        .direction = "down"
    ) %>%
    fill(
        corresponding_timestamp,
        .direction = "down"
    ) %>%
    select(
        c(
            score_type,
            corresponding_Name,
            cumulative_max,
            corresponding_timestamp
        )
    )

# Records
highest_scores_per_type |>
    group_by(
        score_type
    ) |>
    slice(n()) |>
    rename(
        c(
            "Record" = score_type,
            "Name" = corresponding_Name,
            "Value" = cumulative_max,
            "Date" = corresponding_timestamp
        )
    ) |>
    gt(
        groupname_col = NULL,
        rowname_col = "Record"
    ) |>
    tab_header(
        title = "Leaderboards"
    )
```