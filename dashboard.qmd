---
title: "Wingspan Data"
author: "Noah Bolohan"
format: dashboard
---

```{r "imports"}
library(tidyverse)
library(gt)
library(plotly)

invisible(
    lapply(
        list.files(
            "./R",
            full.names = TRUE
        ),
        source
    )
)
```

```{r "Download Google Sheet"}
wingspan_scores <- get_google_sheet(
  sheetId = 2096833443
)

wingspan_scores <- wingspan_scores |>
    mutate(
        game = 1:nrow(
            wingspan_scores
        ),
        .before = 1
    )
```

```{r "Stacked player score"}
stacked_player_scores <- lapply(
        1:7,
        iterative_pivot,
        df = wingspan_scores
    ) |> 
    bind_rows() |>
    drop_na() |>
    group_by(game) |>
    mutate(
        winner = case_when(
        score >= max(score, na.rm = TRUE) ~ TRUE,
        .default = FALSE
        )
    ) |>
    ungroup()
```

:::::: {.rows}

::::: {.card height="100%"}
```{r "Table: Summary"}

name <- "Alex"

player_scores_total <- stacked_player_scores |>
    filter(
        Name == name,
        score_type == "total_score"
    ) |>
    arrange(
        game
    )
    
summary_frame <- data.frame(
    Measure = c(
    "Games played",
    "Games won",
    "Win rate",
    "Max score",
    "Min score",
    "Mean score"
    ),
    Value = c(
        nrow(
            player_scores_total
        ),
        sum(
            player_scores_total["winner"]
        ),
        paste0(
            round(
                100 * sum(
                    player_scores_total["winner"]
                ) / nrow(
                    player_scores_total
                ),
                2
            ),
            " %"
        ),
        max(
            player_scores_total["score"]
        ),
        min(
            player_scores_total["score"]
        ),
        paste(
            round(
                colMeans(
                    player_scores_total["score"]
                ),
                2
            ),
            " (+/-",
            round(
                colSdColMeans(
                    player_scores_total["score"]
                ),
                2
            ),
            ")",
            sep=""
        )
    )
)

summary_frame |>
    gt() |>
    tab_header(
        title = name
    ) |>
    tab_options(
        column_labels.hidden = TRUE
    )

```

:::::

::::: {.card height="100%"}

```{r "Plot: Total score per game"}

player_scores_total <- stacked_player_scores |>
    filter(
        score_type == "total_score"
    ) |>
    group_by(
        Name
    ) |>
    mutate(
        group_size = n()
    ) |> 
    filter(
        group_size >= 10
    ) |>
    arrange(
        game
    ) |>
    mutate(
        game_number = row_number()
    ) %>%
    split(
        .,
        .$Name
    )

p <- player_scores_total[[1]] %>%
    plot_ly( 
        x = ~game_number,
        y = ~score,
        type = "scatter",
        mode = "lines",
        visible = TRUE
    )   

for (name in names(player_scores_total)[-1]) {
    if (name != "Alex") {
        p <- p %>% add_lines(
            data = player_scores_total[[name]],
            x = ~game_number,
            y = ~score,
            visible = FALSE,
            name = name
        )
    }
}
  
pp <- p %>%
  layout(
    title = list(
      text = "Total score per game",
      x = 0,
      xanchor = "left"
    ),
    xaxis = list(title = "Game number"),
    yaxis = list(title = "Score"),
    showlegend = FALSE,
    margin = list(
        l=0,
        r=0
    ),
    updatemenus = list(
        list(
            y = 1.15,
            yanchor="top",
            x = 0.99,
            xanchor = "right",
            buttons = lapply(
                names(player_scores_total),
                function(name) {
                    list(
                        method="update", 
                        args = list(
                            list(
                                visible = as.logical(
                                    match(
                                        names(
                                            player_scores_total
                                        ),
                                        name,
                                        nomatch=FALSE
                                    )
                                )
                            ),
                            list(
                                yaxis = list(
                                    title = "Score"
                                ),
                                title = "Total scores per game"
                            ) 
                        ),
                        label = name
                    )
                }
            )
        )
    )
  ) |>
  config(
    modeBarButtonsToRemove = list(
        "zoom2d",
        "pan2d",
        "toImage",
        "zoomIn2d",
        "zoomOut2d",
        "autoScale2d",
        "hoverCompareCartesian",
        "hoverClosestCartesian"
    ),
    displayModeBar = FALSE
  )

pp
```

:::::

::::::